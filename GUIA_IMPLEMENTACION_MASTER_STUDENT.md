# üöÄ GU√çA COMPLETA: IMPLEMENTACI√ìN MASTER-STUDENT

## üìã **√çNDICE**
1. [Arquitectura del Sistema](#arquitectura)
2. [Implementar Nueva Intenci√≥n](#nueva-intencion)
3. [Implementar Nueva Sub-intenci√≥n](#nueva-sub-intencion)
4. [Implementar Nuevo Int√©rprete](#nuevo-interprete)
5. [Centralizaci√≥n de Prompts](#centralizacion-prompts)
6. [Casos de Uso Pr√°cticos](#casos-uso)

---

## üèóÔ∏è **ARQUITECTURA DEL SISTEMA** {#arquitectura}

### **FLUJO PRINCIPAL:**
```
Usuario ‚Üí Master ‚Üí Specialist ‚Üí ActionExecutor ‚Üí Master (Vocero)
```

### **COMPONENTES CLAVE:**
- **MasterInterpreter**: Int√©rprete humano universal - An√°lisis sem√°ntico completo
- **StudentQueryInterpreter**: Ejecutor t√©cnico especializado en datos de alumnos
- **HelpInterpreter**: Especialista en ayuda del sistema
- **ActionExecutor**: Ejecuta acciones t√©cnicas
- **PromptManagers**: Centralizan todos los prompts

### **PROCESO MENTAL DEL MASTER (OBLIGATORIO):**
```
PASO 1: An√°lisis sem√°ntico puro (¬øqu√© quiere realmente?)
PASO 2: Verificaci√≥n de informaci√≥n suficiente
PASO 3: An√°lisis de contexto conversacional
PASO 4: Verificaci√≥n de capacidades de interpreters
PASO 5: Preparaci√≥n de instrucci√≥n clara
PASO 6: Delegaci√≥n con contexto completo
```

**üìñ DOCUMENTACI√ìN COMPLETA:** Ver `PROCESO_MENTAL_MASTER_COMPLETO.md`

---

## üéØ **IMPLEMENTAR NUEVA INTENCI√ìN** {#nueva-intencion}

### **PASO 1: Definir la Intenci√≥n**
```python
# Ejemplo: "gestion_profesores"
NUEVA_INTENCION = {
    "nombre": "gestion_profesores",
    "descripcion": "TODO sobre profesores - b√∫squedas, horarios, asignaciones",
    "especialista": "TeacherQueryInterpreter",  # Nuevo int√©rprete
    "sub_intenciones": [
        "busqueda_profesor",
        "horarios_profesor", 
        "asignaciones_materia"
    ]
}
```

### **PASO 2: Actualizar MasterKnowledge**
**Archivo**: `app/core/ai/interpretation/master_knowledge.py`

```python
# Agregar en self.interpreters_map (l√≠nea ~32)
"TeacherQueryInterpreter": {
    "domain": "Gesti√≥n de profesores y horarios",
    "intentions": {
        "gestion_profesores": {
            "description": "TODO sobre profesores",
            "sub_intentions": {
                "busqueda_profesor": {
                    "description": "Buscar profesores por nombre, materia, etc.",
                    "examples": ["buscar profesor Garc√≠a", "maestros de matem√°ticas"]
                },
                "horarios_profesor": {
                    "description": "Consultar horarios y disponibilidad",
                    "examples": ["horario del profesor L√≥pez", "disponibilidad martes"]
                }
            }
        }
    }
}
```

### **PASO 3: Actualizar MasterInterpreter**
**Archivo**: `app/core/ai/interpretation/master_interpreter.py`

```python
# Agregar en self.system_map
"TeacherQueryInterpreter": {
    "handles": ["gestion_profesores"],
    "sub_intentions": ["busqueda_profesor", "horarios_profesor", "asignaciones_materia"],
    "capabilities": "Consultas de profesores, horarios, asignaciones",
    "description": "Especialista en gesti√≥n de profesores"
}
```

### **PASO 4: Actualizar MasterPromptManager**
**Archivo**: `app/core/ai/prompts/master_prompt_manager.py`

```python
# Agregar en el prompt principal (l√≠nea ~172)
4. **gestion_profesores**: TODO sobre profesores (b√∫squedas, horarios, asignaciones)
   - Sub-intenciones:
     * **busqueda_profesor**: Buscar profesores por criterios
     * **horarios_profesor**: Consultar horarios y disponibilidad
     * **asignaciones_materia**: Materias asignadas a profesores

# Agregar en sub_intention (l√≠nea ~378)
"sub_intention": "busqueda_simple|...|busqueda_profesor|horarios_profesor|asignaciones_materia",
```

---

## üéØ **IMPLEMENTAR NUEVA SUB-INTENCI√ìN** {#nueva-sub-intencion}

### **EJEMPLO: Agregar "calificaciones_alumno" a consulta_alumnos**

### **PASO 1: Actualizar MasterKnowledge**
```python
# En self.interpreters_map["StudentQueryInterpreter"]["intentions"]["consulta_alumnos"]["sub_intentions"]
"calificaciones_alumno": {
    "description": "Consultar calificaciones espec√≠ficas de un alumno",
    "capabilities": ["calificaciones", "notas", "boletas"],
    "examples": ["calificaciones de Juan", "notas de Mar√≠a Garc√≠a", "boleta de Pedro"]
}
```

### **PASO 2: Actualizar MasterPromptManager**
```python
# Agregar en sub-intenciones de consulta_alumnos
* **calificaciones_alumno**: Consultar calificaciones espec√≠ficas

# Agregar en sub_intention
"sub_intention": "busqueda_simple|...|calificaciones_alumno",
```

### **PASO 3: Actualizar StudentQueryInterpreter**
**Archivo**: `app/core/ai/interpretation/student_query_interpreter.py`

```python
# En el m√©todo de procesamiento, agregar l√≥gica para la nueva sub-intenci√≥n
if sub_intention == "calificaciones_alumno":
    # L√≥gica espec√≠fica para calificaciones
    action_request = self._create_calificaciones_request(user_query, entities)
```

### **PASO 4: Actualizar StudentPromptManager**
**Archivo**: `app/core/ai/prompts/student_query_prompt_manager.py`

```python
# Agregar ejemplos de mapeo
- "calificaciones de Juan" ‚Üí BUSCAR_UNIVERSAL (criterio: nombre=Juan, campos: calificaciones)
- "notas del alumno" ‚Üí BUSCAR_UNIVERSAL (incluir: calificaciones)
```

---

## üéØ **IMPLEMENTAR NUEVO INT√âRPRETE** {#nuevo-interprete}

### **EJEMPLO: TeacherQueryInterpreter**

### **PASO 1: Crear el Int√©rprete**
**Archivo**: `app/core/ai/interpretation/teacher_query_interpreter.py`

```python
from app.core.ai.interpretation.base_interpreter import BaseInterpreter
from app.core.logging import get_logger

class TeacherQueryInterpreter(BaseInterpreter):
    """Especialista en gesti√≥n de profesores"""
    
    def __init__(self, db_path: str, gemini_client=None):
        super().__init__("TeacherQueryInterpreter", priority=8)
        self.logger = get_logger(__name__)
        self.db_path = db_path
        self.gemini_client = gemini_client
        
        # Importar ActionExecutor para profesores
        from app.core.actions.teacher_action_executor import TeacherActionExecutor
        self.action_executor = TeacherActionExecutor(db_path)
    
    def can_handle(self, context) -> bool:
        """Determina si puede manejar la consulta"""
        return context.user_message and "profesor" in context.user_message.lower()
    
    def interpret(self, context) -> InterpretationResult:
        """Procesa consultas de profesores"""
        try:
            # L√≥gica similar a StudentQueryInterpreter
            # pero adaptada para profesores
            pass
        except Exception as e:
            self.logger.error(f"Error en TeacherQueryInterpreter: {e}")
            return None
```

### **PASO 2: Crear PromptManager Espec√≠fico**
**Archivo**: `app/core/ai/prompts/teacher_prompt_manager.py`

```python
from app.core.ai.prompts.base_prompt_manager import BasePromptManager

class TeacherPromptManager(BasePromptManager):
    """Manager de prompts para gesti√≥n de profesores"""
    
    def get_teacher_search_prompt(self, user_query: str) -> str:
        """Prompt para b√∫squeda de profesores"""
        unified_header = self.get_unified_prompt_header("especialista en profesores")
        
        return f"""
{unified_header}

CONTEXTO: Sistema de gesti√≥n de profesores
CONSULTA: {user_query}

ACCIONES DISPONIBLES:
- BUSCAR_PROFESOR: Buscar por nombre, materia, departamento
- CONSULTAR_HORARIO: Ver horarios y disponibilidad
- LISTAR_MATERIAS: Materias asignadas

RESPONDE con la acci√≥n m√°s apropiada.
"""
```

### **PASO 3: Crear ActionExecutor Espec√≠fico**
**Archivo**: `app/core/actions/teacher_action_executor.py`

```python
class TeacherActionExecutor:
    """Ejecutor de acciones para profesores"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
    
    def execute(self, action_request: dict):
        """Ejecuta acciones espec√≠ficas de profesores"""
        action = action_request.get('action')
        
        if action == "BUSCAR_PROFESOR":
            return self._buscar_profesor(action_request)
        elif action == "CONSULTAR_HORARIO":
            return self._consultar_horario(action_request)
        # ... m√°s acciones
    
    def _buscar_profesor(self, request):
        """Implementa b√∫squeda de profesores"""
        # L√≥gica SQL espec√≠fica para profesores
        pass
```

### **PASO 4: Registrar en el Sistema**
**Archivo**: `app/core/ai/interpretation/master_interpreter.py`

```python
# En __init__
from app.core.ai.interpretation.teacher_query_interpreter import TeacherQueryInterpreter

# Agregar a specialists
self.specialists["TeacherQueryInterpreter"] = TeacherQueryInterpreter(
    db_path=self.db_path, 
    gemini_client=self.gemini_client
)
```

---

## üéØ **CENTRALIZACI√ìN DE PROMPTS** {#centralizacion-prompts}

### **ESTRUCTURA ACTUAL:**
```
app/core/ai/prompts/
‚îú‚îÄ‚îÄ base_prompt_manager.py      # Identidad unificada
‚îú‚îÄ‚îÄ master_prompt_manager.py    # Prompts del Master
‚îú‚îÄ‚îÄ student_query_prompt_manager.py  # Prompts del Student
‚îú‚îÄ‚îÄ help_prompt_manager.py      # Prompts del Help
‚îî‚îÄ‚îÄ __init__.py                 # Imports centralizados
```

### **MODIFICAR RESPUESTAS F√ÅCILMENTE:**

#### **1. Cambiar Personalidad Global**
**Archivo**: `app/core/ai/prompts/base_prompt_manager.py`

```python
def get_unified_prompt_header(self, role_context: str = "") -> str:
    """PERSONALIDAD GLOBAL - Modificar aqu√≠ afecta TODO el sistema"""
    return f"""
Eres el Asistente de IA Escolar de {self.get_school_name()}.

PERSONALIDAD ACTUALIZADA:
- M√°s formal y profesional
- Respuestas m√°s concisas
- Enfoque en eficiencia

{role_context}
"""
```

#### **2. Cambiar Respuestas del HelpInterpreter**
**Archivo**: `app/core/ai/interpretation/help_interpreter.py`

```python
# Buscar las respuestas hardcodeadas y centralizarlas
RESPUESTAS_HELP = {
    "SOBRE_CREADOR": """
¬°Hola! üëã Me cre√≥ Angel, un desarrollador experto...
[MODIFICAR AQU√ç LA RESPUESTA]
""",
    "AUTO_CONSCIENCIA": """
Soy tu Asistente de IA Escolar...
[MODIFICAR AQU√ç LA RESPUESTA]
""",
    "LIMITACIONES_HONESTAS": """
Te soy honesto, estas son mis limitaciones...
[MODIFICAR AQU√ç LA RESPUESTA]
"""
}
```

#### **3. Centralizar Mapeos de Acciones**
**Archivo**: `app/core/ai/prompts/student_query_prompt_manager.py`

```python
# Todas las reglas de mapeo est√°n centralizadas aqu√≠
MAPEO_ACCIONES = {
    "estadisticas": {
        "cuantos_alumnos": "CALCULAR_ESTADISTICA",
        "distribucion": "CALCULAR_ESTADISTICA", 
        "total_estudiantes": "CALCULAR_ESTADISTICA"
    },
    "busquedas": {
        "buscar_alumno": "BUSCAR_UNIVERSAL",
        "encontrar_estudiante": "BUSCAR_UNIVERSAL"
    }
}
```

---

## üéØ **CASOS DE USO PR√ÅCTICOS** {#casos-uso}

### **CASO 1: Implementar GeneralInterpreter**

```python
# 1. Crear el int√©rprete
class GeneralInterpreter(BaseInterpreter):
    """Maneja conversaci√≥n general y consultas no espec√≠ficas"""
    
    def can_handle(self, context) -> bool:
        # L√≥gica para detectar conversaci√≥n general
        return not any(keyword in context.user_message.lower() 
                      for keyword in ["alumno", "constancia", "ayuda"])

# 2. Agregar al Master
"GeneralInterpreter": {
    "handles": ["conversacion_general"],
    "sub_intentions": ["saludo", "despedida", "charla_casual"],
    "capabilities": "Conversaci√≥n natural y consultas generales"
}

# 3. Crear prompts espec√≠ficos
class GeneralPromptManager(BasePromptManager):
    def get_conversation_prompt(self, user_query: str) -> str:
        return f"""
{self.get_unified_prompt_header("asistente conversacional")}

Mant√©n una conversaci√≥n natural sobre: {user_query}
"""
```

### **CASO 2: Modificar Respuesta de Limitaciones**

```python
# En help_interpreter.py, cambiar:
if action == "LIMITACIONES":
    return {
        "action": "LIMITACIONES_HONESTAS",
        "response": """
ü§ñ Mis limitaciones actualizadas:

1. üìä **Datos**: Solo accedo a la informaci√≥n de esta escuela
2. üîÑ **Tiempo real**: No me actualizo autom√°ticamente
3. üåê **Internet**: No puedo buscar informaci√≥n externa
4. üìù **Edici√≥n**: No puedo modificar datos directamente

¬°Pero soy muy bueno en lo que hago! üí™
""",
        "success": True
    }
```

---

## ‚úÖ **CHECKLIST DE IMPLEMENTACI√ìN**

### **Nueva Intenci√≥n:**
- [ ] Actualizar MasterKnowledge
- [ ] Actualizar MasterInterpreter.system_map
- [ ] Actualizar MasterPromptManager
- [ ] Crear/Actualizar Int√©rprete espec√≠fico
- [ ] Probar con consultas reales

### **Nueva Sub-intenci√≥n:**
- [ ] Actualizar MasterKnowledge.sub_intentions
- [ ] Actualizar MasterPromptManager.sub_intention
- [ ] Actualizar l√≥gica del Int√©rprete
- [ ] Actualizar PromptManager espec√≠fico
- [ ] Probar mapeo correcto

### **Nuevo Int√©rprete:**
- [ ] Crear clase heredando BaseInterpreter
- [ ] Implementar can_handle() e interpret()
- [ ] Crear PromptManager espec√≠fico
- [ ] Crear ActionExecutor espec√≠fico
- [ ] Registrar en MasterInterpreter
- [ ] Actualizar MasterKnowledge
- [ ] Probar integraci√≥n completa

---

## üîÑ **PROTOCOLO ESTANDARIZADO DE COMUNICACI√ìN**

### **IMPLEMENTACI√ìN CON PROTOCOLO GARANTIZADO**

Todas las nuevas funcionalidades DEBEN seguir el **protocolo estandarizado** definido en [PROTOCOLO_COMUNICACION_ESTANDARIZADO.md](PROTOCOLO_COMUNICACION_ESTANDARIZADO.md).

#### **CHECKLIST DE PROTOCOLO PARA NUEVAS FUNCIONALIDADES:**

```python
# ‚úÖ MASTER: Detectar entidades completas
detected_entities = {
    "limite_resultados": limite_detectado,
    "filtros": filtros_identificados,
    "nombres": nombres_encontrados,
    "accion_principal": accion_determinada,
    # ... TODAS las entidades necesarias
}

# ‚úÖ MASTER: Transferir entidades completas
context.intention_info = {
    'detected_entities': detected_entities,  # ‚úÖ COMPLETAS
    'intention_type': intention_type,
    'sub_intention': sub_intention,
    'reasoning': razonamiento_completo
}

# ‚úÖ STUDENT: Recibir entidades completas
self.master_intention = context.intention_info
limite = self._get_master_limit()           # ‚úÖ ACCESO GARANTIZADO
filtros = self._get_master_filters()        # ‚úÖ ACCESO GARANTIZADO

# ‚úÖ STUDENT: Reportar resultados completos
return InterpretationResult(
    action=accion_ejecutada,
    parameters={
        "data": resultados,
        "row_count": len(resultados),
        "sql_executed": sql_query,
        "master_intention": self.master_intention,  # ‚úÖ PRESERVAR CONTEXTO
        # ... datos t√©cnicos completos
    }
)
```

#### **VALIDACI√ìN AUTOM√ÅTICA:**

```python
# AGREGAR EN CADA NUEVO INT√âRPRETE
def validate_protocol_compliance(self, context, result):
    """Valida cumplimiento del protocolo estandarizado"""

    # Validar recepci√≥n de entidades
    if not hasattr(context, 'intention_info'):
        self.logger.error("‚ùå PROTOCOLO: Falta intention_info")
        return False

    # Validar detected_entities
    entities = context.intention_info.get('detected_entities', {})
    if not entities:
        self.logger.warning("‚ö†Ô∏è PROTOCOLO: detected_entities vac√≠as")

    # Validar reporte completo
    required_params = ['data', 'row_count', 'master_intention']
    for param in required_params:
        if param not in result.parameters:
            self.logger.error(f"‚ùå PROTOCOLO: Falta {param} en reporte")
            return False

    return True
```

#### **LOGGING OBLIGATORIO:**

```python
# EN CADA NUEVO INT√âRPRETE
self.logger.info(f"üéØ [NUEVO_INTERPRETE] Entidades recibidas: {list(entities.keys())}")
self.logger.info(f"üéØ [NUEVO_INTERPRETE] L√≠mite aplicado: {limite}")
self.logger.info(f"üéØ [NUEVO_INTERPRETE] Filtros aplicados: {filtros}")
self.logger.info(f"üì§ [NUEVO_INTERPRETE] Reportando: {action} ‚Üí {row_count} resultados")
```

### **GARANT√çAS DE FUNCIONAMIENTO:**

- ‚úÖ **Transferencia completa** de entidades Master ‚Üí Student
- ‚úÖ **Acceso garantizado** a l√≠mites y filtros en Student
- ‚úÖ **Reporte completo** Student ‚Üí Master
- ‚úÖ **Preservaci√≥n de contexto** en toda la cadena
- ‚úÖ **Validaci√≥n autom√°tica** del protocolo
- ‚úÖ **Logging detallado** en puntos cr√≠ticos
- ‚úÖ **Fallbacks robustos** para cada componente

---

**üéØ RESULTADO**: Sistema Master-Student completamente extensible, mantenible y con **protocolo estandarizado** que garantiza funcionamiento robusto al 100%.
