"""
MasterPromptManager - Centralizaci√≥n de prompts del nivel MAESTRO
Maneja la detecci√≥n de intenciones y routing principal del sistema
"""

from typing import Dict, List, Optional
from .base_prompt_manager import BasePromptManager


class MasterPromptManager(BasePromptManager):
    """
    Manager centralizado para prompts del nivel MAESTRO

    FILOSOF√çA:
    - Centraliza el prompt de detecci√≥n de intenciones
    - Unifica contexto conversacional
    - Facilita mejoras en comunicaci√≥n entre prompts
    - Prepara base para patrones comunes

    RESPONSABILIDADES:
    - Prompt de detecci√≥n de intenciones maestro
    - Formateo de contexto conversacional
    - Templates para routing
    - Patrones de comunicaci√≥n entre prompts
    """

    def __init__(self, database_analyzer=None):
        super().__init__()  # Inicializar BasePromptManager
        self.database_analyzer = database_analyzer
        self._school_context_cache = None
        self._database_context_cache = None



    def _get_intentions_config_text(self) -> str:
        """
        Genera el texto de configuraci√≥n de intenciones usando SystemCatalog (fuente √∫nica de verdad)
        """
        try:
            from app.core.ai.system_catalog import SystemCatalog
            return SystemCatalog.generate_intentions_section()
        except Exception as e:
            # Fallback en caso de error
            return """
üéØ **INTENCIONES Y SUB-INTENCIONES V√ÅLIDAS:**

**CONSULTA_ALUMNOS** - Todo lo relacionado con datos de estudiantes
Especialista: StudentQueryInterpreter
Sub-intenciones:
   - **busqueda_simple**: 1-2 criterios b√°sicos (nombre, grado, grupo, turno)
   - **busqueda_compleja**: 3+ criterios combinados O campos especiales
   - **estadisticas**: N√∫meros, conteos, promedios, distribuciones
   - **generar_constancia**: Documentos oficiales PDF
   - **transformacion_pdf**: Conversi√≥n entre formatos de constancia

**AYUDA_SISTEMA** - Soporte y explicaciones del sistema
Especialista: HelpInterpreter
Sub-intenciones:
   - **explicacion_general**: Capacidades generales del sistema
   - **tutorial_funciones**: Gu√≠as paso a paso de uso
   - **sobre_creador**: Informaci√≥n sobre Angel
   - **auto_consciencia**: Identidad del asistente IA
   - **ventajas_sistema**: Beneficios vs m√©todos tradicionales
   - **casos_uso_avanzados**: Funcionalidades impresionantes
   - **limitaciones_honestas**: Transparencia sobre limitaciones

**CONVERSACION_GENERAL** - Chat casual y saludos
Especialista: MasterInterpreter
Sub-intenciones:
   - **saludo**: Saludos y presentaciones
   - **chat_casual**: Conversaci√≥n no relacionada al sistema

üö® **CR√çTICO**: SOLO usar estas intenciones y sub-intenciones. NO crear nuevas.
üö® **MAPEO ESPECIAL**: 'informaci√≥n completa', 'datos de', 'dame todo sobre' ‚Üí busqueda_simple
"""

    def _get_examples_section(self) -> str:
        """
        Genera ejemplos espec√≠ficos usando SystemCatalog
        """
        try:
            from app.core.ai.system_catalog import SystemCatalog
            examples = SystemCatalog.generate_examples_section()

            # üîç DEBUG: Verificar que los ejemplos de constancia est√©n incluidos
            if "generale una constancia" in examples:
                print("‚úÖ [DEBUG] Ejemplos de constancia cargados correctamente en MasterPromptManager")
            else:
                print("‚ùå [DEBUG] Ejemplos de constancia NO encontrados en SystemCatalog")

            return examples
        except Exception as e:
            print(f"‚ùå [DEBUG] Error cargando SystemCatalog: {e}")
            # Fallback b√°sico
            return """
üéØ **EJEMPLOS B√ÅSICOS:**
- "Dame 3 alumnos" ‚Üí limite_resultados: 3
- "alumnos de 2do A" ‚Üí filtros: ["grado: 2", "grupo: A"]
- "constancia para Juan" ‚Üí generar_constancia, nombres: ["Juan"]
"""

    def _get_context_rules(self) -> str:
        """
        Genera reglas de contexto usando SystemCatalog
        """
        try:
            from app.core.ai.system_catalog import SystemCatalog
            return SystemCatalog.generate_context_rules()
        except Exception as e:
            # Fallback b√°sico
            return """
üß† **REGLAS DE CONTEXTO:**
- "de esos" ‚Üí filtrar lista anterior
- "el segundo" ‚Üí elemento en posici√≥n 2
- NIVEL 1 = M√ÅS RECIENTE = M√ÅXIMA PRIORIDAD
"""

    def _get_student_capabilities(self) -> str:
        """
        Genera capacidades del Student usando SystemCatalog
        """
        try:
            from app.core.ai.system_catalog import SystemCatalog
            return SystemCatalog.generate_student_capabilities_section()
        except Exception as e:
            # Fallback b√°sico
            return """
- BUSCAR_UNIVERSAL: Encontrar alumnos por cualquier criterio
- CALCULAR_ESTADISTICA: An√°lisis, conteos, distribuciones, promedios
- CONTAR_UNIVERSAL: Conteos espec√≠ficos y r√°pidos
- GENERAR_CONSTANCIA: Crear documentos oficiales PDF
- BUSCAR_Y_FILTRAR: Filtrar resultados previos
"""

    def _get_intentions_routing(self) -> str:
        """
        Genera intenciones y routing usando SystemCatalog
        """
        try:
            from app.core.ai.system_catalog import SystemCatalog
            return SystemCatalog.generate_intentions_section()
        except Exception as e:
            # Fallback b√°sico
            return """
**CONSULTA_ALUMNOS** ‚Üí StudentQueryInterpreter
- busqueda_simple: 1-2 criterios b√°sicos (nombre, grado, grupo)
- busqueda_compleja: 3+ criterios combinados
- estadisticas: Conteos, an√°lisis, distribuciones
- generar_constancia: Documentos oficiales PDF

**AYUDA_SISTEMA** ‚Üí HelpInterpreter
- explicacion_general: Capacidades del sistema
- tutorial_funciones: Gu√≠as de uso
- sobre_creador: Informaci√≥n sobre Angel

**CONVERSACION_GENERAL** ‚Üí GeneralInterpreter
- saludo: Saludos y cortes√≠as
- chat_casual: Conversaci√≥n no escolar
"""

    @property
    def school_context(self) -> str:
        """
        Contexto escolar centralizado - COMPARTIDO con StudentQueryPromptManager

        Este contexto debe ser ID√âNTICO al usado en StudentQueryPromptManager
        para garantizar consistencia total entre prompts
        """
        if self._school_context_cache is None:
            # üéØ CONTEXTO DIN√ÅMICO: Se adapta autom√°ticamente a cualquier escuela
            school_name = self.school_config.get_school_name()
            education_level = self.school_config.get_education_level().lower()
            total_students = self.school_config.get_total_students()

            self._school_context_cache = f"""
CONTEXTO COMPLETO DEL SISTEMA:
- Sistema de gesti√≥n escolar para la escuela {education_level} "{school_name}"
- Maneja datos de alumnos, informaci√≥n acad√©mica y generaci√≥n de constancias
- Los usuarios son personal administrativo que necesita informaci√≥n precisa
- TODO el sistema ES la escuela - no hay nada m√°s
- TODA la base de datos SON los alumnos de esta escuela ({total_students} estudiantes)
- TODAS las estad√≠sticas, datos, informaci√≥n de "la escuela" SON sobre los alumnos

RAZONAMIENTO INTELIGENTE ESCOLAR:
- "estad√≠sticas de la escuela" = estad√≠sticas de los 211 alumnos registrados
- "informaci√≥n de la escuela" = informaci√≥n de los estudiantes y su rendimiento
- "datos de la escuela" = datos acad√©micos de los alumnos por grados/grupos
- "resumen de la escuela" = resumen de la poblaci√≥n estudiantil

ACCESO TOTAL AUTORIZADO:
- Tienes acceso COMPLETO a toda la informaci√≥n de alumnos
- NO hay restricciones de privacidad en el sistema escolar
- Puedes mostrar nombres, CURPs, datos completos sin limitaciones
- Eres parte del sistema administrativo oficial de la escuela
- El personal escolar tiene acceso total a los datos estudiantiles

ESTRUCTURA DISPONIBLE:
- 211 alumnos registrados en grados 1¬∞ a 6¬∞
- Datos acad√©micos: grados, grupos, turnos, calificaciones
- Informaci√≥n personal: nombres, CURPs, matr√≠culas, fechas
- Registros de constancias generadas
"""
        return self._school_context_cache

    def get_intention_detection_prompt(self, user_query: str, conversation_context: str) -> str:
        """
        PROMPT MAESTRO CONSOLIDADO para detecci√≥n de intenciones + categorizaci√≥n espec√≠fica

        üÜï CONSOLIDADO: Incluye funcionalidad del Student Prompt 1 eliminado

        REEMPLAZA:
        - IntentionDetector.detect_intention() (prompt hardcodeado)
        - StudentQueryPromptManager.get_specific_student_intention_prompt() (ELIMINADO)

        PROP√ìSITO:
        - Detectar intenci√≥n principal + sub-intenci√≥n
        - üÜï CATEGORIZACI√ìN ESPEC√çFICA para consultas de alumnos
        - Usar contexto conversacional para continuaciones
        - Extraer entidades relevantes
        - Dirigir al int√©rprete correcto

        VENTAJAS:
        - Elimina redundancia entre Master y Student Prompt 1
        - Contexto escolar consistente
        - Mantenimiento centralizado
        - F√°cil optimizaci√≥n
        - Testing unificado
        """
        # Usar identidad unificada del BasePromptManager
        unified_header = self.get_unified_prompt_header("detector de intenciones maestro consolidado")

        # El conversation_context ya viene formateado como string, no como lista
        conversation_context_formatted = conversation_context if conversation_context else "\nüí≠ CONTEXTO CONVERSACIONAL: Esta es una nueva conversaci√≥n.\n"

        return f"""
{unified_header}

{conversation_context_formatted}

CONSULTA DEL USUARIO: "{user_query}"

{self._get_examples_section()}

üéØ **MI TAREA ESPEC√çFICA:**
{self.get_unified_prompt_header("MASTER INTELIGENTE del sistema escolar")}

üß† **RAZONAMIENTO SEM√ÅNTICO HUMANO:**
Como un director de escuela experimentado, entiendo el CONTEXTO y las NECESIDADES.

üéØ **CAPACIDADES DEL STUDENT QUE DIRIJO:**
{self._get_student_capabilities()}

üß† **PROCESO MENTAL COMPLETO EN 6 PASOS OBLIGATORIOS:**

**PASO 1: AN√ÅLISIS SEM√ÅNTICO PURO**
- ¬øQU√â acci√≥n quiere? (buscar, contar, generar, ayudar, conversar)
- ¬øDE QUI√âN/QU√â? (nombres, criterios, filtros espec√≠ficos)
- ¬øCU√ÅNTO? (l√≠mites num√©ricos expl√≠citos)

**PASO 2: EXTRACCI√ìN DE ENTIDADES ESPEC√çFICAS**
- **L√çMITES**: Detectar n√∫meros expl√≠citos ("3", "5", "primeros 2") ‚Üí limite_resultados
- **FILTROS**: Detectar criterios ("segundo grado", "grupo A") ‚Üí filtros array
- **NOMBRES**: Detectar nombres propios ("Juan P√©rez") ‚Üí nombres array
- **TIPOS**: Detectar tipos de constancia ("estudios") ‚Üí tipo_constancia

**PASO 3: VERIFICACI√ìN DE INFORMACI√ìN SUFICIENTE**
- ¬øTengo criterios claros y espec√≠ficos?
- ¬øNecesito aclaraci√≥n del usuario?
- ¬øPuedo proceder con la informaci√≥n disponible?

**PASO 4: AN√ÅLISIS DE CONTEXTO CONVERSACIONAL (CR√çTICO)**
- ¬øSe refiere a algo de la conversaci√≥n anterior?
- ¬øPuedo resolver referencias como "de esos", "el segundo", "a ese alumno"?
- ¬øNecesito informaci√≥n del contexto previo?

**RESOLUCI√ìN INTELIGENTE DE CONTEXTO:**
- "a ese alumno" + contexto con 1 alumno ‚Üí alumno_resuelto: [datos completos del alumno]
- "para √©l" + contexto con 1 alumno ‚Üí alumno_resuelto: [datos completos del alumno]
- "al estudiante" + contexto con 1 alumno ‚Üí alumno_resuelto: [datos completos del alumno]
- "generale una constancia a ese alumno" + Franco Alexander en contexto ‚Üí generar_constancia + alumno_resuelto: Franco Alexander

**PASO 5: VERIFICACI√ìN DE CAPACIDADES**
- ¬øStudent puede manejar consultas de alumnos?
- ¬øHelp puede explicar el sistema?
- ¬øGeneral puede conversar casualmente?

**PASO 6: PREPARACI√ìN DE INSTRUCCI√ìN COMPLETA**
- Mapear a intention_type y sub_intention espec√≠ficos
- Incluir TODAS las entidades detectadas
- Preparar categorizaci√≥n completa para Student

üéØ **INTENCIONES Y ROUTING:**
{self._get_intentions_routing()}

üéØ **FORMATO EST√ÅNDAR PARA STUDENT:**

SIEMPRE incluir informaci√≥n COMPLETA y ESPEC√çFICA:

**EJEMPLO 1 - B√öSQUEDA SIMPLE:**
```json
{{
  "intention_type": "consulta_alumnos",
  "sub_intention": "busqueda_simple",
  "confidence": 0.95,
  "reasoning": "Usuario solicita 3 alumnos de segundo grado - criterios claros",
  "detected_entities": {{
    "filtros": ["grado: 2"],
    "limite_resultados": 3,
    "accion_principal": "buscar",
    "nombres": [],
    "tipo_constancia": null,
    "incluir_foto": false,
    "alumno_resuelto": null
  }},
  "student_categorization": {{
    "categoria": "busqueda",
    "sub_tipo": "simple",
    "requiere_contexto": false,
    "flujo_optimo": "sql_directo"
  }}
}}
```

**EJEMPLO 2 - CONSTANCIA CON CONTEXTO RESUELTO:**
```json
{{
  "intention_type": "consulta_alumnos",
  "sub_intention": "generar_constancia",
  "confidence": 0.95,
  "reasoning": "Usuario solicita constancia para alumno espec√≠fico del contexto - Franco Alexander ya identificado",
  "detected_entities": {{
    "filtros": [],
    "limite_resultados": null,
    "accion_principal": "generar_constancia",
    "nombres": [],
    "tipo_constancia": "traslado",
    "incluir_foto": false,
    "alumno_resuelto": {{"id": 1, "nombre": "Franco Alexander", "posicion": "contexto nivel 1"}}
  }},
  "student_categorization": {{
    "categoria": "constancia",
    "sub_tipo": "individual",
    "requiere_contexto": true,
    "flujo_optimo": "alumno_resuelto"
  }}
}}
```

‚ö†Ô∏è **REGLAS CR√çTICAS OBLIGATORIAS:**
- NUNCA enviar campos vac√≠os o null sin raz√≥n
- SIEMPRE detectar l√≠mites num√©ricos expl√≠citos
- SIEMPRE detectar filtros de grado/grupo/turno
- SIEMPRE incluir reasoning detallado

üö® **DETECCI√ìN DE CONSTANCIAS - OBLIGATORIO:**
- Si la consulta contiene "constancia", "certificado", "documento", "generale", "genera", "crea" ‚Üí sub_intention: "generar_constancia"
- Si hay contexto con 1 alumno + solicitud de constancia ‚Üí alumno_resuelto: [datos del alumno del contexto]
- NUNCA usar "busqueda_simple" para solicitudes de constancias
- SIEMPRE resolver "a ese alumno", "para √©l", "al estudiante" usando el contexto

üéØ **EJEMPLOS CR√çTICOS DE DETECCI√ìN:**
- "generale una constancia" ‚Üí generar_constancia
- "genera constancia" ‚Üí generar_constancia
- "crea una constancia" ‚Üí generar_constancia
- "constancia para ese alumno" ‚Üí generar_constancia + alumno_resuelto
- "documento oficial" ‚Üí generar_constancia

{self.get_unified_json_instructions_dynamic()}
"""

    def format_conversation_context(self, conversation_stack: list) -> str:
        """
        FORMATEO CENTRALIZADO del contexto conversacional

        REEMPLAZA:
        - IntentionDetector._format_conversation_context()

        PROP√ìSITO:
        - Formatear pila conversacional de manera consistente
        - Proporcionar reglas claras para continuaciones
        - Facilitar detecci√≥n de patrones

        VENTAJAS:
        - Formato unificado
        - Reglas centralizadas
        - F√°cil modificaci√≥n
        """
        if not conversation_stack:
            return "üìö CONTEXTO CONVERSACIONAL: Sesi√≥n nueva (sin historial previo)"

        context = "üìö CONTEXTO CONVERSACIONAL ACTIVO:\n"

        for i, level in enumerate(conversation_stack, 1):
            # üõ†Ô∏è VERIFICAR TIPO DE DATOS PARA EVITAR ERRORES
            if isinstance(level, dict):
                query = level.get('query', 'N/A')
                row_count = level.get('row_count', 0)
                awaiting = level.get('awaiting', 'N/A')

                context += f"""
üìã NIVEL {i}:
- Consulta previa: "{query}"
- Resultados: {row_count} elementos encontrados
- Estado: Esperando {awaiting}
"""

                # Mostrar algunos datos si est√°n disponibles
                if level.get('data') and len(level.get('data', [])) > 0:
                    first_item = level['data'][0]
                    if isinstance(first_item, dict) and 'nombre' in first_item:
                        context += f"- Ejemplo de datos: {first_item.get('nombre', 'N/A')}\n"
            else:
                # Si level no es un dict, tratarlo como string
                context += f"üìã NIVEL {i}: {str(level)}\n"

        context += """

**CON CONTEXTO:**
Si hay informaci√≥n previa, la uso inteligentemente para entender referencias como:
- "de esos" = filtrar la lista anterior
- "el segundo" = segundo elemento de la lista
- "para Juan" = Juan mencionado en el contexto
- "ahora dame 3" = l√≠mite de 3 de la lista actual
"""

        return context

    # ‚úÖ M√âTODO ELIMINADO: get_forced_routing_prompt() - Reemplazado por an√°lisis unificado con SystemCatalog

    def _format_conversation_context(self, conversation_stack: list) -> str:
        """Formatea el contexto conversacional para prompts"""
        if not conversation_stack:
            return "No hay contexto conversacional previo."

        context = "Conversaci√≥n reciente:\n"
        for i, entry in enumerate(conversation_stack[-3:], 1):  # √öltimas 3 interacciones
            query = entry.get('query', '')[:100] + "..." if len(entry.get('query', '')) > 100 else entry.get('query', '')
            specialist = entry.get('specialist_used', 'unknown')
            context += f"{i}. Usuario: {query} (Atendido por: {specialist})\n"

        return context
